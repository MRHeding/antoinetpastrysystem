<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Antonette's Pastries</title>
    <link href="css/output.css" rel="stylesheet">
    <link href="assets/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <div id="navigation-container"></div>

    <!-- Success Content -->
    <section class="min-h-screen flex items-center justify-center py-16 px-4">
        <div class="max-w-2xl w-full">
            <!-- Loading State -->
            <div id="loading-state" class="bg-white rounded-lg shadow-lg p-8 text-center">
                <div class="mb-6">
                    <i class="fas fa-spinner fa-spin text-6xl text-amber-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Verifying Payment...</h2>
                <p class="text-gray-600">Please wait while we confirm your payment.</p>
            </div>

            <!-- Success State -->
            <div id="success-state" class="hidden bg-white rounded-lg shadow-lg p-8 text-center">
                <div class="mb-6">
                    <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-green-100">
                        <i class="fas fa-check text-4xl text-green-600"></i>
                    </div>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Payment Successful!</h2>
                <p class="text-gray-600 mb-2">Thank you for your order.</p>
                <p class="text-lg font-semibold text-amber-600 mb-8">Order #<span id="order-number"></span></p>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-8">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-green-600 text-xl mr-3 mt-1"></i>
                        <div class="text-left">
                            <p class="text-green-800 font-semibold mb-2">What's Next?</p>
                            <ul class="text-green-700 text-sm space-y-1">
                                <li>• Your payment has been confirmed</li>
                                <li>• We've received your order and will start preparing it</li>
                                <li>• You can track your order status on the Orders page</li>
                                <li>• We'll notify you when your order is ready</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="orders.html" class="bg-amber-600 text-white px-8 py-3 rounded-md hover:bg-amber-700 transition duration-200 font-semibold">
                        <i class="fas fa-list mr-2"></i>View My Orders
                    </a>
                    <a href="products.html" class="bg-gray-100 text-gray-700 px-8 py-3 rounded-md hover:bg-gray-200 transition duration-200 font-semibold">
                        <i class="fas fa-shopping-bag mr-2"></i>Continue Shopping
                    </a>
                </div>

                <p class="text-sm text-gray-500 mt-6">Redirecting to orders page in <span id="countdown">5</span> seconds...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden bg-white rounded-lg shadow-lg p-8 text-center">
                <div class="mb-6">
                    <div class="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-red-100">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-600"></i>
                    </div>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Payment Verification Failed</h2>
                <p class="text-gray-600 mb-8">We couldn't verify your payment. Please check your orders or contact support.</p>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="orders.html" class="bg-amber-600 text-white px-8 py-3 rounded-md hover:bg-amber-700 transition duration-200 font-semibold">
                        <i class="fas fa-list mr-2"></i>Check My Orders
                    </a>
                    <a href="contact.html" class="bg-gray-100 text-gray-700 px-8 py-3 rounded-md hover:bg-gray-200 transition duration-200 font-semibold">
                        <i class="fas fa-headset mr-2"></i>Contact Support
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <div id="footer-container"></div>

    <script src="js/shared.js"></script>
    <script>
        // Verify payment on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Get session ID from URL first
            const urlParams = new URLSearchParams(window.location.search);
            let sessionId = urlParams.get('session_id');
            
            console.log('URL session_id:', sessionId);
            
            // If session_id is the placeholder or not found, get from localStorage
            if (!sessionId || sessionId === '{CHECKOUT_SESSION_ID}') {
                const pendingOrder = localStorage.getItem('pending_order');
                console.log('Pending order from localStorage:', pendingOrder);
                
                if (pendingOrder) {
                    try {
                        const orderData = JSON.parse(pendingOrder);
                        console.log('Parsed order data:', orderData);
                        sessionId = orderData.checkout_session_id;
                        console.log('Session ID from localStorage:', sessionId);
                    } catch (e) {
                        console.error('Error parsing pending order:', e);
                    }
                }
            }

            // If still no session ID, try to get the most recent pending order from database
            if (!sessionId || sessionId === '{CHECKOUT_SESSION_ID}') {
                console.log('No session ID found, trying to get most recent pending order');
                try {
                    const response = await fetch('api/payment.php?action=get_latest_pending_order');
                    const data = await response.json();
                    console.log('Latest pending order response:', data);
                    
                    if (data.success && data.checkout_session_id) {
                        sessionId = data.checkout_session_id;
                        console.log('Using session ID from latest pending order:', sessionId);
                    }
                } catch (e) {
                    console.error('Error getting latest pending order:', e);
                }
            }

            if (!sessionId || sessionId === '{CHECKOUT_SESSION_ID}') {
                console.error('Could not retrieve session ID from any source');
                showErrorState('Could not retrieve payment information. Please check your orders page.');
                return;
            }
            
            console.log('Final session ID to verify:', sessionId);

            try {
                // Verify payment with backend
                const response = await fetch(`api/payment.php?action=verify_payment&session_id=${sessionId}`);
                const data = await response.json();

                console.log('Payment verification response:', data);

                if (data.success && data.payment_status === 'paid') {
                    // Show success state
                    showSuccessState(data.order_number);
                    
                    // Clear cart
                    localStorage.removeItem('cart');
                    localStorage.removeItem('pending_order');
                    
                    // Update cart display
                    if (typeof updateCartDisplay === 'function') {
                        updateCartDisplay();
                    }
                    
                    // Redirect after 5 seconds
                    let countdown = 5;
                    const countdownEl = document.getElementById('countdown');
                    const interval = setInterval(() => {
                        countdown--;
                        if (countdownEl) {
                            countdownEl.textContent = countdown;
                        }
                        if (countdown <= 0) {
                            clearInterval(interval);
                            window.location.href = 'orders.html';
                        }
                    }, 1000);
                } else {
                    console.error('Payment verification failed:', data);
                    showErrorState(data.message || 'Unknown error', data.debug_info);
                }
            } catch (error) {
                console.error('Error verifying payment:', error);
                showErrorState('Network error: ' + error.message);
            }
        });

        function showSuccessState(orderNumber) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('success-state').classList.remove('hidden');
            document.getElementById('order-number').textContent = orderNumber;
        }

        function showErrorState(errorMessage, debugInfo) {
            document.getElementById('loading-state').classList.add('hidden');
            const errorState = document.getElementById('error-state');
            errorState.classList.remove('hidden');
            
            // Add detailed error message if provided
            if (errorMessage) {
                const errorTitle = errorState.querySelector('h2');
                const errorText = errorState.querySelector('p');
                errorText.textContent = errorMessage;
                
                // Add debug info in console
                if (debugInfo) {
                    console.error('Debug info:', debugInfo);
                }
            }
        }
    </script>
</body>
</html>

